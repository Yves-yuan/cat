create database if not exists tmp;
drop table if exists tmp.user;
create table tmp.user
ENGINE = MergeTree()
order by userId
as select
trimBoth(register_phone_no) as userId
,'ab38843611168113' as dataSourceId
,'LOGIN_USER_ATTRIBUTES' as eventType
,ifNull(concat(toString(toUnixTimestamp(addHours(toDateTime(now()),-8))),'000'),'') as `timestamp`
,map(
'is_member',toString(trimBoth(ifNull(is_member,'')))
,'is_shopper',toString(trimBoth(ifNull(is_shopper,'')))
,'is_consumber',toString(trimBoth(ifNull(is_consumber,'')))
,'member_card',toString(trimBoth(ifNull(member_card,'')))
,'off_member_id',toString(trimBoth(ifNull(off_member_id,'')))
,'crm_member_id',toString(trimBoth(ifNull(crm_member_id,'')))
,'wechat_app_openid',toString(trimBoth(ifNull(wechat_app_openid,'')))
,'tmall_member_id',toString(trimBoth(ifNull(tmall_member_id,'')))
,'jd_member_id',toString(trimBoth(ifNull(jd_member_id,'')))
,'jd_shopperid',toString(trimBoth(ifNull(jd_shopperid,'')))
,'tmall_shopperid',toString(trimBoth(ifNull(tmall_shopperid,'')))
,'wechat_unionid',toString(trimBoth(ifNull(wechat_unionid,'')))
,'wechat_app_nickname',toString(trimBoth(ifNull(wechat_app_nickname,'')))
,'tmall_nickname',toString(trimBoth(ifNull(tmall_nickname,'')))
,'jd_nickname',toString(trimBoth(ifNull(jd_nickname,'')))
,'wechat_app_user_name',toString(trimBoth(ifNull(wechat_app_user_name,'')))
,'tmall_user_name',toString(trimBoth(ifNull(tmall_user_name,'')))
,'jd_user_name',toString(trimBoth(ifNull(jd_user_name,'')))
,'off_user_name',toString(trimBoth(ifNull(off_user_name,'')))
,'gender',toString(trimBoth(ifNull(gender,'')))
,'birthday',toString(trimBoth(ifNull(toString(birthday),'')))
,'age',toString(trimBoth(ifNull(toString(age),'')))
,'age_cohorts',toString(trimBoth(ifNull(age_cohorts,'')))
,'native_place',toString(trimBoth(ifNull(native_place,'')))
,'family_income',toString(trimBoth(ifNull(toString(family_income),'')))
,'state',toString(trimBoth(ifNull(state,'')))
,'province',toString(trimBoth(ifNull(state,'')))
,'city',toString(trimBoth(ifNull(city,'')))
,'city_grade',toString(trimBoth(ifNull(city_grade,'')))
,'county',toString(trimBoth(ifNull(county,'')))
,'street',toString(trimBoth(ifNull(street,'')))
,'delivery_address',toString(trimBoth(ifNull(delivery_address,'')))
,'marital_status',toString(trimBoth(ifNull(marital_status,'')))
,'chinese_zodiac',toString(trimBoth(ifNull(chinese_zodiac,'')))
,'constellation',toString(trimBoth(ifNull(constellation,'')))
,'is_kid',toString(trimBoth(ifNull(is_kid,'')))
,'kid_num',toString(trimBoth(ifNull(toString(kid_num),'')))
,'kid_gender_1',toString(trimBoth(ifNull(kid_gender_1,'')))
,'kid_birthday_1',toString(trimBoth(ifNull(toString(kid_birthday_1),'')))
,'kid_age_1',toString(trimBoth(ifNull(toString(kid_age_1),'')))
,'kid_age_cohorts_1',toString(trimBoth(ifNull(toString(kid_age_cohorts_1),'')))
,'kid_age_learn_phase_1',toString(trimBoth(ifNull(toString(kid_age_learn_phase_1),'')))
,'kid_gender_2',toString(trimBoth(ifNull(kid_gender_2,'')))
,'kid_birthday_2',toString(trimBoth(ifNull(toString(kid_birthday_2),'')))
,'kid_age_2',toString(trimBoth(ifNull(toString(kid_age_2),'')))
,'kid_age_cohorts_2',toString(trimBoth(ifNull(toString(kid_age_cohorts_2),'')))
,'kid_age_learn_phase_2',toString(trimBoth(ifNull(toString(kid_age_learn_phase_2),'')))
,'kid_gender_3',toString(trimBoth(ifNull(kid_gender_3,'')))
,'kid_birthday_3',toString(trimBoth(ifNull(toString(kid_birthday_3),'')))
,'kid_age_3',toString(trimBoth(ifNull(toString(kid_age_3),'')))
,'kid_age_cohorts_3',toString(trimBoth(ifNull(toString(kid_age_cohorts_3),'')))
,'kid_age_learn_phase_3',toString(trimBoth(ifNull(toString(kid_age_learn_phase_3),'')))
,'is_consent_letter',toString(trimBoth(ifNull(is_consent_letter,'')))
,'is_touch_crm',toString(trimBoth(ifNull(is_touch_crm,'')))
,'first_buy_date',toString(trimBoth(ifNull(toString(first_buy_date),'')))
,'all_channel_first_day_num_today',toString(trimBoth(ifNull(toString(all_channel_first_day_num_today),'')))
,'all_channel_first_day_num_crm',toString(trimBoth(ifNull(toString(all_channel_first_day_num_crm),'')))
,'last_buy_date',toString(trimBoth(ifNull(toString(last_buy_date),'')))
,'all_channel_last_day_num_pos',toString(trimBoth(ifNull(toString(all_channel_last_day_num_pos),'')))
,'all_channel_his_buy_avg_day_num',toString(trimBoth(ifNull(toString(all_channel_his_buy_avg_day_num),'')))
,'crm_usable_coupon',toString(trimBoth(ifNull(toString(crm_usable_coupon),'')))
,'coupon_preference_verification_m',toString(trimBoth(ifNull(toString(coupon_preference_verification_m),'')))
,'his_add_convert_point_preference_m',toString(trimBoth(ifNull(toString(his_add_convert_point_preference_m),'')))
,'about_to_past_due_point_num_Xm',toString(trimBoth(ifNull(toString(about_to_past_due_point_num_Xm),'')))
,'wechat_app_member_grade',toString(trimBoth(ifNull(wechat_app_member_grade,'')))
,'pos_member_grade',toString(trimBoth(ifNull(pos_member_grade,'')))
,'jd_member_grade',toString(trimBoth(ifNull(jd_member_grade,'')))
,'tmall_member_grade',toString(trimBoth(ifNull(tmall_member_grade,'')))
,'wechat_app_member_register_date',toString(trimBoth(ifNull(toString(wechat_app_member_register_date),'')))
,'wechat_app_member_register_age_month',toString(trimBoth(ifNull(toString(wechat_app_member_register_age_month),'')))
,'is_tmall_member',toString(trimBoth(ifNull(is_tmall_member,'')))
,'tmall_member_register_date',toString(trimBoth(ifNull(toString(tmall_member_register_date),'')))
,'tmall_member_register_age_month',toString(trimBoth(ifNull(toString(tmall_member_register_age_month),'')))
,'tmall_buy_first_time',toString(trimBoth(ifNull(toString(tmall_buy_first_time),'')))
,'tmall_buy_last_time',toString(trimBoth(ifNull(toString(tmall_buy_last_time),'')))
,'tmall_buy_last_register_day_num',toString(trimBoth(ifNull(toString(tmall_buy_last_register_day_num),'')))
,'tmall_buy_first_register_day_num',toString(trimBoth(ifNull(toString(tmall_buy_first_register_day_num),'')))
,'tmall_his_buy_avg_day_num',toString(trimBoth(ifNull(toString(tmall_his_buy_avg_day_num),'')))
,'tmall_buy_first_day_num_today',toString(trimBoth(ifNull(toString(tmall_buy_first_day_num_today),'')))
,'tmall_buy_last_day_num_today',toString(trimBoth(ifNull(toString(tmall_buy_last_day_num_today),'')))
,'is_jd_member',toString(trimBoth(ifNull(is_jd_member,'')))
,'jd_member_register_date',toString(trimBoth(ifNull(toString(jd_member_register_date),'')))
,'jd_member_register_age_month',toString(trimBoth(ifNull(toString(jd_member_register_age_month),'')))
,'jd_buy_first_time',toString(trimBoth(ifNull(toString(jd_buy_first_time),'')))
,'jd_buy_last_time',toString(trimBoth(ifNull(toString(jd_buy_last_time),'')))
,'jd_buy_last_register_day_num',toString(trimBoth(ifNull(toString(jd_buy_last_register_day_num),'')))
,'jd_buy_first_register_day_num',toString(trimBoth(ifNull(toString(jd_buy_first_register_day_num),'')))
,'jd_his_buy_avg_day_num',toString(trimBoth(ifNull(toString(jd_his_buy_avg_day_num),'')))
,'jd_buy_first_day_num_today',toString(trimBoth(ifNull(toString(jd_buy_first_day_num_today),'')))
,'jd_buy_last_day_num_today',toString(trimBoth(ifNull(toString(jd_buy_last_day_num_today),'')))
,'is_crm_member',toString(trimBoth(ifNull(is_crm_member,'')))
,'crm_member_starts',toString(trimBoth(ifNull(crm_member_starts,'')))
,'crm_member_register_date',toString(trimBoth(ifNull(toString(crm_member_register_date),'')))
,'crm_member_register_age_month',toString(trimBoth(ifNull(toString(crm_member_register_age_month),'')))
,'is_inside_staff',toString(trimBoth(ifNull(is_inside_staff,'')))
,'is_blacklist',toString(trimBoth(ifNull(is_blacklist,'')))
,'is_dealer_member',toString(trimBoth(ifNull(is_dealer_member,'')))
,'pos_memeber_register_date',toString(trimBoth(ifNull(toString(pos_memeber_register_date),'')))
,'pos_member_register_age_month',toString(trimBoth(ifNull(toString(pos_member_register_age_month),'')))
,'pos_buy_first_time',toString(trimBoth(ifNull(toString(pos_buy_first_time),'')))
,'pos_buy_last_time',toString(trimBoth(ifNull(toString(pos_buy_last_time),'')))
,'pos_buy_last_register_day_num',toString(trimBoth(ifNull(toString(pos_buy_last_register_day_num),'')))
,'pos_buy_first_register_day_num',toString(trimBoth(ifNull(toString(pos_buy_first_register_day_num),'')))
,'pos_his_buy_avg_day_num',toString(trimBoth(ifNull(toString(pos_his_buy_avg_day_num),'')))
,'pos_buy_first_day_num_today',toString(trimBoth(ifNull(toString(pos_buy_first_day_num_today),'')))
,'pos_buy_last_day_num_today',toString(trimBoth(ifNull(toString(pos_buy_last_day_num_today),'')))
,'crm_identity_type',toString(trimBoth(ifNull(crm_identity_type,'')))
,'crm_identity_code',toString(trimBoth(ifNull(crm_identity_code,'')))
,'crm_usable_point',toString(trimBoth(ifNull(toString(crm_usable_point),'')))
,'user_email',toString(trimBoth(ifNull(user_email,'')))
,'zip_code',toString(trimBoth(ifNull(zip_code,'')))
,'educational_status',toString(trimBoth(ifNull(educational_status,'')))
,'user_job',toString(trimBoth(ifNull(user_job,'')))
,'monthly_pay',toString(trimBoth(ifNull(toString(monthly_pay),'')))
,'hobbies_interests',toString(trimBoth(ifNull(hobbies_interests,'')))
,'is_wechat_app_member',toString(trimBoth(ifNull(is_wechat_app_member,'')))
,'ly_associated_rate',toString(trimBoth(ifNull(ly_associated_rate,'')))
,'tm_associated_rate',toString(trimBoth(ifNull(tm_associated_rate,'')))
,'jd_associated_rate',toString(trimBoth(ifNull(jd_associated_rate,'')))
,'all_buy_associated_rate',toString(trimBoth(ifNull(all_buy_associated_rate,'')))
,'is_weekend_user',toString(trimBoth(ifNull(is_weekend_user,'')))
,'is_festival_user',toString(trimBoth(ifNull(is_festival_user,'')))
,'is_cny_festival_user',toString(trimBoth(ifNull(is_cny_festival_user,'')))
,'is_kid_festival_user',toString(trimBoth(ifNull(is_kid_festival_user,'')))
,'is_holiday_festival_user',toString(trimBoth(ifNull(is_holiday_festival_user,'')))
,'is_christmas_festival_user',toString(trimBoth(ifNull(is_christmas_festival_user,'')))
,'is_festival_user_618',toString(trimBoth(ifNull(is_festival_user_618,'')))
,'is_festival_user_1111',toString(trimBoth(ifNull(is_festival_user_1111,'')))
,'is_festival_user_1212',toString(trimBoth(ifNull(is_festival_user_1212,'')))
,'is_super_brand_day',toString(trimBoth(ifNull(is_super_brand_day,'')))
,'monthly_pay',toString(trimBoth(ifNull(toString(monthly_pay),'')))
,'his_past_due_all_point',toString(trimBoth(ifNull(toString(his_past_due_all_point),'')))
,'all_buy_packages_num',toString(trimBoth(ifNull(toString(all_buy_packages_num),'')))
,'all_buy_order_num',toString(trimBoth(ifNull(toString(all_buy_order_num),'')))
,'crm_member_channel',toString(trimBoth(ifNull(toString(crm_member_channel),'')))
,'is_dealer_member_s',toString(trimBoth(ifNull(toString(is_dealer_member_s),'')))
,'dealer_member_source',toString(trimBoth(ifNull(toString(dealer_member_source),'')))
,'member_grade_code',toString(trimBoth(ifNull(member_grade_code,'')))
,'member_grade_name',toString(trimBoth(ifNull(member_grade_name,'')))
) as attributes
from
dim.dim_party_user_all
where register_phone_no !='' and register_phone_no is not null
;